---
global:
  imagePullSecrets:
    - ecr-registry-secret

backstage:
  image:
    registry: 635314249418.dkr.ecr.us-east-2.amazonaws.com
    repository: shoutsky-backstage
    tag: latest
    
  appConfig:
    app:
      title: shoutsky lab
      baseUrl: http://backstage-dev.skylarhoughtongithub.local
    
    organization:
      name: shoutsky
    
    backend:
      baseUrl: http://backstage-dev.skylarhoughtongithub.local
      listen:
        port: 7007
        host: 0.0.0.0
      cors:
        origin: http://backstage-dev.skylarhoughtongithub.local
        methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
        credentials: true
      database:
        client: pg
        connection:
          host: backstage-postgresql
          port: 5432
          user: backstage
          password: ${POSTGRES_PASSWORD}
          database: backstage

    auth:
      providers:
        guest: {}
        github:
          development:
            clientId: ${GITHUB_CLIENT_ID}
            clientSecret: ${GITHUB_CLIENT_SECRET}

    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}

    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: local-cluster
              authProvider: 'serviceAccount'
              serviceAccountToken: ${K8S_SERVICE_ACCOUNT_TOKEN}
              caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt

    techdocs:
      builder: local
      generator:
        runIn: local
      publisher:
        type: awsS3
        awsS3:
          bucketName: skylab-backstage-techdocs
          region: us-east-2

    argocd:
      username: ${ARGOCD_USERNAME}
      password: ${ARGOCD_PASSWORD}
      appLocatorMethods:
        - type: 'config'
          instances:
            - name: argo
              url: http://argocd.skylarhoughtongithub.local
              token: ${ARGOCD_TOKEN}

    proxy:
      endpoints:
        '/argocd/api':
          target: http://argocd.skylarhoughtongithub.local/api/v1/
          changeOrigin: true
          secure: false
          headers:
            Cookie: ${ARGOCD_TOKEN}

    catalog:
      import:
        entityFilename: catalog-info.yaml
        pullRequestBranchName: backstage-integration
      rules:
        - allow: [Component, System, API, Resource, Location]
      locations:
        - type: url
          target: https://github.com/backstage/backstage/blob/master/packages/catalog-model/examples/all.yaml
        - type: url
          target: https://github.com/SkylarHoughtonGithub/skylab-backstage-catalog/blob/main/infra-templates/eks/template.yaml  
          rules:
          - allow: [Template]
        - type: url
          target: https://github.com/SkylarHoughtonGithub/skylab-backstage-catalog/blob/main/workload-templates/tetris-react/template.yaml
          rules:
          - allow: [Template]
          
  extraEnvVars:
    - name: NODE_ENV
      value: development
    - name: GITHUB_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: backstage-github-oauth
          key: client-id
    - name: GITHUB_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: backstage-github-oauth
          key: client-secret
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
          name: backstage-github-oauth
          key: token
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: backstage-aws-creds
          key: aws_access_key_id
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: backstage-aws-creds
          key: aws_secret_access_key
    - name: AWS_REGION
      value: "us-east-2"
    - name: K8S_SERVICE_ACCOUNT_TOKEN
      valueFrom:
        secretKeyRef:
          name: backstage-k8s-token
          key: token
    - name: ARGOCD_TOKEN
      valueFrom:
        secretKeyRef:
          name: backstage-argocd-creds
          key: token
    - name: ARGOCD_USERNAME
      valueFrom:
        secretKeyRef:
          name: backstage-argocd-creds
          key: username
    - name: ARGOCD_PASSWORD
      valueFrom:
        secretKeyRef:
          name: backstage-argocd-creds
          key: password

  extraVolumeMounts: []
  extraVolumes: []

postgresql:
  enabled: true
  auth:
    username: backstage
    existingSecret: backstage-postgresql-creds
    secretKeys:
      adminPasswordKey: admin-password
      userPasswordKey: user-password